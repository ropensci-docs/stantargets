<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="stantargets">
<title>Bayesian simulation pipelines with stantargets • stantargets</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian simulation pipelines with stantargets">
<meta property="og:description" content="stantargets">
<meta property="og:image" content="https://docs.ropensci.org/stantargets/logo.svg">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">stantargets</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0.9001</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Vignettes</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://docs.ropensci.org/targets">targets</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://mc-stan.org/cmdstanr/index.html">cmdstanr</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/stantargets">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="simulation_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><link href="simulation_files/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="simulation_files/vis-9.1.0/vis-network.min.js"></script><script src="simulation_files/visNetwork-binding-2.1.2/visNetwork.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Bayesian simulation pipelines with stantargets</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/stantargets/blob/HEAD/vignettes/simulation.Rmd" class="external-link"><code>vignettes/simulation.Rmd</code></a></small>
      <div class="d-none name"><code>simulation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>The <a href="https://docs.ropensci.org/stantargets/articles/introduction.html">introductory vignette</a> vignette caters to Bayesian data analysis workflows with few datasets to analyze. However, it is sometimes desirable to run one or more Bayesian models repeatedly across multiple simulated datasets. Examples:</p>
<ol style="list-style-type: decimal">
<li>Validate the implementation of a Bayesian model using simulation.</li>
<li>Simulate a randomized controlled experiment to explore frequentist properties such as power and Type I error.</li>
</ol>
<p>This vignette focuses on (1).</p>
</div>
<div class="section level2">
<h2 id="example-project">Example project<a class="anchor" aria-label="anchor" href="#example-project"></a>
</h2>
<p>Visit <a href="https://github.com/wlandau/stantargets-example-validation" class="external-link uri">https://github.com/wlandau/stantargets-example-validation</a> for an example project based on this vignette. The example has an <a href="https://rstudio.cloud/project/2466069" class="external-link">RStudio Cloud workspace</a> which allows you to run the project in a web browser.</p>
</div>
<div class="section level2">
<h2 id="interval-based-model-validation-pipeline">Interval-based model validation pipeline<a class="anchor" aria-label="anchor" href="#interval-based-model-validation-pipeline"></a>
</h2>
<p>This particular example uses the concept of calibration that Bob Carpenter <a href="https://statmodeling.stat.columbia.edu/2017/04/12/bayesian-posteriors-calibrated/" class="external-link">explains here</a> <span class="citation">(Carpenter 2017)</span>. The goal is to simulate multiple datasets from the model below, analyze each dataset, and assess how often the estimated posterior intervals cover the true parameters from the prior predictive simulations. If coverage is no systematically different from nominal, this is evidence that the model was implemented correctly. The quantile method by <span class="citation">Cook, Gelman, and Rubin (2006)</span> generalizes this concept, and simulation-based calibration <span class="citation">(Talts et al. 2020)</span> generalizes further. The interval-based technique featured in this vignette is not as robust as SBC, but it may be more expedient for large models because it does not require visual inspection of multiple histograms. See a later section in this vignette for an example of simulation-based calibration on this same model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lines</span> <span class="op">&lt;-</span> <span class="st">"data {</span></span>
<span><span class="st">  int &lt;lower = 1&gt; n;</span></span>
<span><span class="st">  vector[n] x;</span></span>
<span><span class="st">  vector[n] y;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">parameters {</span></span>
<span><span class="st">  vector[2] beta;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">model {</span></span>
<span><span class="st">  y ~ normal(beta[1] + x * beta[2], 1);</span></span>
<span><span class="st">  beta ~ normal(0, 1);</span></span>
<span><span class="st">}"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">lines</span>, <span class="st">"model.stan"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we define a pipeline to simulate multiple datasets and fit each dataset with the model. In our data-generating function, we put the true parameter values of each simulation in a special <code>.join_data</code> list. <code>stantargets</code> will automatically join the elements of <code>.join_data</code> to the correspondingly named variables in the summary output. This will make it super easy to check how often our posterior intervals capture the truth. As for scale, generate 10 datasets (5 batches with 2 replications each) and run the model on each of the 10 datasets.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Internally, each batch is a &lt;a href="https://books.ropensci.org/targets/dynamic.html" class="external-link"&gt;dynamic branch target&lt;/a&gt;, and the number of replications determines the amount of work done within a branch. In the general case, &lt;a href="https://books.ropensci.org/targets/dynamic.html#batching" class="external-link"&gt;batching&lt;/a&gt; is a way to find the right compromise between target-specific overhead and the horizontal scale of the pipeline.&lt;/p&gt;'><sup>1</sup></a> By default, each of the 10 model runs computes 4 MCMC chains with 2000 MCMC iterations each (including burn-in) and you can adjust with the <code>chains</code>, <code>iter_sampling</code>, and <code>iter_warmup</code> arguments of <code><a href="../reference/tar_stan_mcmc_rep_summary.html">tar_stan_mcmc_rep_summary()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># _targets.R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/stantargets/">stantargets</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>crayon.enabled <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Use computer memory more sparingly:</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_option_set.html" class="external-link">tar_option_set</a></span><span class="op">(</span>memory <span class="op">=</span> <span class="st">"transient"</span>, garbage_collection <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, to <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="va">n</span>,</span>
<span>    x <span class="op">=</span> <span class="va">x</span>,</span>
<span>    y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    .join_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/tar_stan_mcmc_rep_summary.html">tar_stan_mcmc_rep_summary</a></span><span class="op">(</span></span>
<span>    <span class="va">model</span>,</span>
<span>    <span class="st">"model.stan"</span>,</span>
<span>    <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span>, <span class="co"># Runs once per rep.</span></span>
<span>    batches <span class="op">=</span> <span class="fl">5</span>, <span class="co"># Number of branch targets.</span></span>
<span>    reps <span class="op">=</span> <span class="fl">2</span>, <span class="co"># Number of model reps per branch target.</span></span>
<span>    variables <span class="op">=</span> <span class="st">"beta"</span>,</span>
<span>    summaries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="op">~</span><span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/quantile2.html" class="external-link">quantile2</a></span><span class="op">(</span><span class="va">.x</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    stdout <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    stderr <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We now have a pipeline that runs the model 10 times: 5 batches (branch targets) with 2 replications per batch.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html" class="external-link">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">Warning message:</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; package ‘targets’ was built under R version 4.3.3 </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-dfa65de9d6cbe3d6faf6" style="width:672px;height:576px;"></div>
<script type="application/json" data-for="htmlwidget-dfa65de9d6cbe3d6faf6">{"x":{"nodes":{"name":["model","model_batch","model_data","model_file_model","model_model","simulate_data"],"type":["stem","stem","pattern","stem","pattern","function"],"description":[null,null,null,"model.stan","model.stan",null],"status":["outdated","outdated","outdated","outdated","outdated","outdated"],"seconds":[null,null,null,null,null,null],"bytes":[null,null,null,null,null,null],"branches":[null,null,null,null,null,null],"label":["model","model_batch","model_data","model_file_model\nmodel.stan","model_model\nmodel.stan","simulate_data"],"color":["#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5","#78B7C5"],"id":["model","model_batch","model_data","model_file_model","model_model","simulate_data"],"level":[4,1,2,1,3,1],"shape":["dot","dot","square","dot","square","triangle"]},"edges":{"from":["model_batch","simulate_data","model_data","model_file_model","model_model"],"to":["model_data","model_data","model_model","model_model","model"],"arrows":["to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Stem","Pattern","Function"],"color":["#78B7C5","#899DA4","#899DA4","#899DA4"],"shape":["dot","dot","square","triangle"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script><p>Run the computation with <code><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">tar_make()</a></code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">tar_make</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched target model_batch</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed target model_batch [0.001 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched target model_file_model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed target model_file_model [15.867 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_data_b0b9380a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_data_b0b9380a [0.008 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_data_ffcdb73c</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_data_ffcdb73c [0.003 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_data_b968a03a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_data_b968a03a [0.003 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_data_f8763cb2</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_data_f8763cb2 [0.003 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_data_0bfdabdc</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_data_0bfdabdc [0.003 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed pattern model_data</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_5d061b58</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_5d061b58 [1.536 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_a9336683</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_a9336683 [1.318 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_bde6a6d6</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_bde6a6d6 [1.323 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_384f982f</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_384f982f [1.323 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_0d59666a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_0d59666a [1.321 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed pattern model_model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched target model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed target model [0 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> ended pipeline [24.006 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; Warning message:</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; package ‘targets’ was built under R version 4.3.3 </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<p>The result is an aggregated data frame of summary statistics, where the <code>.rep</code> column distinguishes among individual replicates. We have the posterior intervals for <code>beta</code> in columns <code>q2.5</code> and <code>q97.5</code>. And thanks to <code>.join_data</code> in <code>simulate_data()</code>, there is a special <code>.join_data</code> column in the output to indicate the true value of each parameter from the simulation.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_load.html" class="external-link">tar_load</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="va">model</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 × 9</span></span></span>
<span><span class="co">#&gt;    variable    q2.5   q97.5 .join_data .rep     .dataset_id    .seed .file .name</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> beta[1]   0.031<span style="text-decoration: underline;">8</span>  1.24       0.751  99bfcc99 model_data_b… 1.49<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> beta[2]  -<span style="color: #BB0000;">1.04</span>    0.734     -<span style="color: #BB0000;">0.592</span>  99bfcc99 model_data_b… 1.49<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> beta[1]   0.472   1.63       1.19   051ce394 model_data_b… 2.04<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> beta[2]  -<span style="color: #BB0000;">0.844</span>   0.911      0.063<span style="text-decoration: underline;">5</span> 051ce394 model_data_b… 2.04<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> beta[1]   1.35    2.52       2.15   4258cff2 model_data_f… 4.83<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> beta[2]  -<span style="color: #BB0000;">1.94</span>   -<span style="color: #BB0000;">0.152</span>     -<span style="color: #BB0000;">1.71</span>   4258cff2 model_data_f… 4.83<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> beta[1]  -<span style="color: #BB0000;">0.230</span>   0.946      0.271  96e3f8e9 model_data_f… 6.64<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> beta[2]  -<span style="color: #BB0000;">1.73</span>    0.047<span style="text-decoration: underline;">6</span>    -<span style="color: #BB0000;">0.407</span>  96e3f8e9 model_data_f… 6.64<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> beta[1]   0.348   1.51       0.758  9e8ac8fd model_data_b… 1.33<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> beta[2]  -<span style="color: #BB0000;">0.794</span>   0.962      0.426  9e8ac8fd model_data_b… 1.33<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> beta[1]  -<span style="color: #BB0000;">0.864</span>   0.322     -<span style="color: #BB0000;">0.541</span>  289ec442 model_data_b… 8.94<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> beta[2]  -<span style="color: #BB0000;">1.24</span>    0.500     -<span style="color: #BB0000;">0.251</span>  289ec442 model_data_b… 8.94<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span> beta[1]  -<span style="color: #BB0000;">0.194</span>   0.998      0.618  7b68a6d3 model_data_f… 3.71<span style="color: #949494;">e</span>7 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span> beta[2]  -<span style="color: #BB0000;">0.551</span>   1.17      -<span style="color: #BB0000;">0.245</span>  7b68a6d3 model_data_f… 3.71<span style="color: #949494;">e</span>7 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span> beta[1]  -<span style="color: #BB0000;">0.913</span>   0.254     -<span style="color: #BB0000;">0.160</span>  fb1ab4a4 model_data_f… 1.33<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span> beta[2]  -<span style="color: #BB0000;">2.52</span>   -<span style="color: #BB0000;">0.751</span>     -<span style="color: #BB0000;">1.07</span>   fb1ab4a4 model_data_f… 1.33<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span> beta[1]  -<span style="color: #BB0000;">2.79</span>   -<span style="color: #BB0000;">1.63</span>      -<span style="color: #BB0000;">1.81</span>   7640ef0e model_data_0… 5.73<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span> beta[2]  -<span style="color: #BB0000;">2.44</span>   -<span style="color: #BB0000;">0.673</span>     -<span style="color: #BB0000;">1.22</span>   7640ef0e model_data_0… 5.73<span style="color: #949494;">e</span>8 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span> beta[1]   0.483   1.64       1.43   c9c1f653 model_data_0… 1.83<span style="color: #949494;">e</span>9 mode… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span> beta[2]  -<span style="color: #BB0000;">1.98</span>   -<span style="color: #BB0000;">0.294</span>     -<span style="color: #BB0000;">1.19</span>   c9c1f653 model_data_0… 1.83<span style="color: #949494;">e</span>9 mode… model</span></span></code></pre></div>
<p>Now, let’s assess how often the estimated 95% posterior intervals capture the true values of <code>beta</code>. If the model is implemented correctly, the coverage value below should be close to 95%. (Ordinarily, we would <a href="https://books.ropensci.org/targets/dynamic.html#batching" class="external-link">increase the number of batches and reps per batch</a> and <a href="https://books.ropensci.org/targets/hpc.html" class="external-link">run batches in parallel computing</a>.)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>coverage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">q2.5</span> <span class="op">&lt;</span> <span class="va">.join_data</span> <span class="op">&amp;</span> <span class="va">.join_data</span> <span class="op">&lt;</span> <span class="va">q97.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   variable coverage</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> beta[1]         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> beta[2]         1</span></span></code></pre></div>
<p>For maximum reproducibility, we should express the coverage assessment as a custom function and a target in the pipeline.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># _targets.R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/stantargets/">stantargets</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, to <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="va">n</span>,</span>
<span>    x <span class="op">=</span> <span class="va">x</span>,</span>
<span>    y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    .join_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/tar_stan_mcmc_rep_summary.html">tar_stan_mcmc_rep_summary</a></span><span class="op">(</span></span>
<span>    <span class="va">model</span>,</span>
<span>    <span class="st">"model.stan"</span>,</span>
<span>    <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    batches <span class="op">=</span> <span class="fl">5</span>, <span class="co"># Number of branch targets.</span></span>
<span>    reps <span class="op">=</span> <span class="fl">2</span>, <span class="co"># Number of model reps per branch target.</span></span>
<span>    variables <span class="op">=</span> <span class="st">"beta"</span>,</span>
<span>    summaries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="op">~</span><span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/quantile2.html" class="external-link">quantile2</a></span><span class="op">(</span><span class="va">.x</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    stdout <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    stderr <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html" class="external-link">tar_target</a></span><span class="op">(</span></span>
<span>    <span class="va">coverage</span>,</span>
<span>    <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>coverage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">q2.5</span> <span class="op">&lt;</span> <span class="va">.join_data</span> <span class="op">&amp;</span> <span class="va">.join_data</span> <span class="op">&lt;</span> <span class="va">q97.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The new <code>coverage</code> target should the only outdated target, and it should be connected to the upstream <code>model</code> target.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html" class="external-link">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">Warning message:</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; package ‘targets’ was built under R version 4.3.3 </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-80fdc8e3b7d3c593ce16" style="width:672px;height:576px;"></div>
<script type="application/json" data-for="htmlwidget-80fdc8e3b7d3c593ce16">{"x":{"nodes":{"name":["model","model_batch","model_data","model_file_model","model_model","coverage","simulate_data"],"type":["stem","stem","pattern","stem","pattern","stem","function"],"description":[null,null,null,"model.stan","model.stan",null,null],"status":["uptodate","uptodate","uptodate","uptodate","uptodate","outdated","uptodate"],"seconds":[0,0.001,0.02,15.867,6.821,null,null],"bytes":[2583,99,1959,2664966,6025,null,null],"branches":[null,null,5,null,5,null,null],"label":["model","model_batch","model_data","model_file_model\nmodel.stan","model_model\nmodel.stan","coverage","simulate_data"],"color":["#354823","#354823","#354823","#354823","#354823","#78B7C5","#354823"],"id":["model","model_batch","model_data","model_file_model","model_model","coverage","simulate_data"],"level":[4,1,2,1,3,5,1],"shape":["dot","dot","square","dot","square","dot","triangle"]},"edges":{"from":["model_batch","simulate_data","model","model_data","model_file_model","model_model"],"to":["model_data","model_data","coverage","model_model","model_model","model"],"arrows":["to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Outdated","Stem","Pattern","Function"],"color":["#354823","#78B7C5","#899DA4","#899DA4","#899DA4"],"shape":["dot","dot","dot","square","triangle"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script><p>When we run the pipeline, only the coverage assessment should run. That way, we skip all the expensive computation of simulating datasets and running MCMC multiple times.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">tar_make</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped target model_batch</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped target model_file_model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_b0b9380a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_ffcdb73c</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_b968a03a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_f8763cb2</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_0bfdabdc</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped pattern model_data</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_model_5d061b58</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_model_a9336683</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_model_bde6a6d6</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_model_384f982f</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_model_0d59666a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped pattern model_model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped target model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched target coverage</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed target coverage [0.011 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> ended pipeline [0.221 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; Warning message:</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; package ‘targets’ was built under R version 4.3.3 </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_read.html" class="external-link">tar_read</a></span><span class="op">(</span><span class="va">coverage</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   variable coverage</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> beta[1]         1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> beta[2]         1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multiple-models">Multiple models<a class="anchor" aria-label="anchor" href="#multiple-models"></a>
</h2>
<p><code>tar_stan_rep_mcmc_summary()</code> and similar functions allow you to supply multiple Stan models. If you do, each model will share the the same collection of datasets, and the <code>.dataset_id</code> column of the model target output allows for custom analyses that compare different models against each other. Suppose we have a new model, <code>model2.stan</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lines</span> <span class="op">&lt;-</span> <span class="st">"data {</span></span>
<span><span class="st">  int &lt;lower = 1&gt; n;</span></span>
<span><span class="st">  vector[n] x;</span></span>
<span><span class="st">  vector[n] y;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">parameters {</span></span>
<span><span class="st">  vector[2] beta;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">model {</span></span>
<span><span class="st">  y ~ normal(beta[1] + x * x * beta[2], 1); // Regress on x^2 instead of x.</span></span>
<span><span class="st">  beta ~ normal(0, 1);</span></span>
<span><span class="st">}"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">lines</span>, <span class="st">"model2.stan"</span><span class="op">)</span></span></code></pre></div>
<p>To set up the simulation workflow to run on both models, we add <code>model2.stan</code> to the <code>stan_files</code> argument of <code>tar_stan_rep_mcmc_summary()</code>. And in the coverage summary below, we group by <code>.name</code> to compute a coverage statistic for each model.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># _targets.R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/stantargets/">stantargets</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, to <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="va">n</span>,</span>
<span>    x <span class="op">=</span> <span class="va">x</span>,</span>
<span>    y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    .join_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/tar_stan_mcmc_rep_summary.html">tar_stan_mcmc_rep_summary</a></span><span class="op">(</span></span>
<span>    <span class="va">model</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"model.stan"</span>, <span class="st">"model2.stan"</span><span class="op">)</span>, <span class="co"># another model</span></span>
<span>    <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    batches <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    reps <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    variables <span class="op">=</span> <span class="st">"beta"</span>,</span>
<span>    summaries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="op">~</span><span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/quantile2.html" class="external-link">quantile2</a></span><span class="op">(</span><span class="va">.x</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    stdout <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    stderr <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_target.html" class="external-link">tar_target</a></span><span class="op">(</span></span>
<span>    <span class="va">coverage</span>,</span>
<span>    <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.name</span>, <span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>coverage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">q2.5</span> <span class="op">&lt;</span> <span class="va">.join_data</span> <span class="op">&amp;</span> <span class="va">.join_data</span> <span class="op">&lt;</span> <span class="va">q97.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In the graph below, notice how targets <code>model_model</code> and <code>model_model2</code> are both connected to <code>model_data</code> upstream. Downstream, <code>model</code> is equivalent to <code>dplyr::bind_rows(model_model, model_model2)</code>, and it will have special columns <code>.name</code> and <code>.file</code> to distinguish among all the models.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html" class="external-link">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">Warning message:</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; package ‘targets’ was built under R version 4.3.3 </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-1ed4896ff451136eeb43" style="width:672px;height:576px;"></div>
<script type="application/json" data-for="htmlwidget-1ed4896ff451136eeb43">{"x":{"nodes":{"name":["coverage","model","model_batch","model_data","model_file_model","model_model","model_file_model2","model_model2","simulate_data"],"type":["stem","stem","stem","pattern","stem","pattern","stem","pattern","function"],"description":[null,null,null,null,"model.stan","model.stan","model2.stan","model2.stan",null],"status":["outdated","outdated","uptodate","uptodate","uptodate","uptodate","outdated","outdated","uptodate"],"seconds":[0.011,0,0.001,0.02,15.867,6.821,null,null,null],"bytes":[173,2583,99,1959,2664966,6025,null,null,null],"branches":[null,null,null,5,null,5,null,null,null],"label":["coverage","model","model_batch","model_data","model_file_model\nmodel.stan","model_model\nmodel.stan","model_file_model2\nmodel2.stan","model_model2\nmodel2.stan","simulate_data"],"color":["#78B7C5","#78B7C5","#354823","#354823","#354823","#354823","#78B7C5","#78B7C5","#354823"],"id":["coverage","model","model_batch","model_data","model_file_model","model_model","model_file_model2","model_model2","simulate_data"],"level":[5,4,1,2,1,3,1,3,1],"shape":["dot","dot","dot","square","dot","square","dot","square","triangle"]},"edges":{"from":["model_data","model_file_model","model","model_batch","simulate_data","model_model","model_model2","model_data","model_file_model2"],"to":["model_model","model_model","coverage","model_data","model_data","model","model","model_model2","model_model2"],"arrows":["to","to","to","to","to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Outdated","Up to date","Stem","Pattern","Function"],"color":["#78B7C5","#354823","#899DA4","#899DA4","#899DA4"],"shape":["dot","dot","dot","square","triangle"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level2">
<h2 id="simulation-based-calibration">Simulation-based calibration<a class="anchor" aria-label="anchor" href="#simulation-based-calibration"></a>
</h2>
<p>This section explores a more rigorous validation study which adopts the proper simulation-based calibration (SBC) method from <span class="citation">(Talts et al. 2020)</span>. To use this method, we need a function that generates rank statistics from a simulated dataset and a data frame of posterior draws. If the model is implemented correctly, these rank statistics will be uniformly distributed for each model parameter. Our function will use the <a href="https://hyunjimoon.github.io/SBC/reference/calculate_ranks_draws_matrix.html" class="external-link"><code>calculate_ranks_draws_matrix()</code></a> function from the <a href="https://hyunjimoon.github.io/SBC/" class="external-link"><code>SBC</code></a> R package <span class="citation">(Kim et al. 2022)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_ranks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">draws</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">draws</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">.join_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">truth</span> <span class="op">&lt;-</span> <span class="fu">map_dbl</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span>,</span>
<span>    <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">.x</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">.join_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">SBC</span><span class="fu">::</span><span class="fu"><a href="https://hyunjimoon.github.io/SBC/reference/calculate_ranks_draws_matrix.html" class="external-link">calculate_ranks_draws_matrix</a></span><span class="op">(</span><span class="va">truth</span>, <span class="fu">as_draws_matrix</span><span class="op">(</span><span class="va">draws</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>To demonstrate this function, we simulate a dataset,</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, to <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="va">n</span>,</span>
<span>    x <span class="op">=</span> <span class="va">x</span>,</span>
<span>    y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    .join_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ n         : int 10</span></span>
<span><span class="co">#&gt;  $ x         : num [1:10] -1 -0.778 -0.556 -0.333 -0.111 ...</span></span>
<span><span class="co">#&gt;  $ y         : num [1:10] -3.007 0.793 -1.739 -2.91 -1.616 ...</span></span>
<span><span class="co">#&gt;  $ .join_data:List of 1</span></span>
<span><span class="co">#&gt;   ..$ beta: num [1:2] -2.144 -0.301</span></span></code></pre></div>
<p>we make up a hypothetical set of posterior draws,</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>`beta[1]` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, `beta[2]` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">draws</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 2</span></span></span>
<span><span class="co">#&gt;    `beta[1]` `beta[2]`</span></span>
<span><span class="co">#&gt;        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1.57    -<span style="color: #BB0000;">0.658</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    -<span style="color: #BB0000;">0.610</span>    0.087<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1.05     0.014<span style="text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1.20    -<span style="color: #BB0000;">0.257</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    -<span style="color: #BB0000;">2.25</span>    -<span style="color: #BB0000;">0.583</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     0.241   -<span style="color: #BB0000;">0.425</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    -<span style="color: #BB0000;">1.23</span>     1.31  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    -<span style="color: #BB0000;">1.83</span>     0.655 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    -<span style="color: #BB0000;">0.703</span>   -<span style="color: #BB0000;">0.461</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     0.156   -<span style="color: #BB0000;">0.331</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span></code></pre></div>
<p>and we call <code>get_ranks()</code> to get the SBC rank statistics for each model parameter.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="fu">get_ranks</span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>, draws <span class="op">=</span> <span class="va">draws</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   `beta[1]` `beta[2]`</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>         1        45</span></span></code></pre></div>
<p>To put this into practice in a pipeline, we supply the symbol <code>get_ranks</code> to the <code>transform</code> argument of <code><a href="../reference/tar_stan_mcmc_rep_draws.html">tar_stan_mcmc_rep_draws()</a></code>. That way, instead of a full set of draws, each replication will return only the output of <code>get_ranks()</code> on those draws (plus a few helper columns). If supplied, the <code>transform</code> argument of <code><a href="../reference/tar_stan_mcmc_rep_draws.html">tar_stan_mcmc_rep_draws()</a></code> must be the name of a function in the pipeline. This function must accept arguments <code>data</code> and <code>draws</code>, and it must return a data frame.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># _targets.R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/targets/" class="external-link">targets</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/stantargets/">stantargets</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_option_set.html" class="external-link">tar_option_set</a></span><span class="op">(</span>packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"posterior"</span>, <span class="st">"purrr"</span>, <span class="st">"tibble"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, to <span class="op">=</span> <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span> <span class="op">*</span> <span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="va">n</span>,</span>
<span>    x <span class="op">=</span> <span class="va">x</span>,</span>
<span>    y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    .join_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">get_ranks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">draws</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">draws</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">.join_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">truth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span>,</span>
<span>    <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">.x</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">.join_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">SBC</span><span class="fu">::</span><span class="fu"><a href="https://hyunjimoon.github.io/SBC/reference/calculate_ranks_draws_matrix.html" class="external-link">calculate_ranks_draws_matrix</a></span><span class="op">(</span><span class="va">truth</span>, <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_matrix.html" class="external-link">as_draws_matrix</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/tar_stan_mcmc_rep_draws.html">tar_stan_mcmc_rep_draws</a></span><span class="op">(</span></span>
<span>    <span class="va">model</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"model.stan"</span><span class="op">)</span>,</span>
<span>    <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    batches <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    reps <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    variables <span class="op">=</span> <span class="st">"beta"</span>,</span>
<span>    stdout <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    stderr <span class="op">=</span> <span class="fu">R.utils</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/R.utils/reference/nullfile.html" class="external-link">nullfile</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    transform <span class="op">=</span> <span class="va">get_ranks</span> <span class="co"># Supply the transform to get SBC ranks.</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Our new function <code>get_ranks()</code> is a dependency of one of our downstream targets, so any changes to <code>get_ranks()</code> will force the results to refresh in the next run of the pipeline.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_visnetwork.html" class="external-link">tar_visnetwork</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">Warning message:</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; package ‘targets’ was built under R version 4.3.3 </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<div class="visNetwork html-widget html-fill-item" id="htmlwidget-2f76bc665b97545f8f8d" style="width:672px;height:576px;"></div>
<script type="application/json" data-for="htmlwidget-2f76bc665b97545f8f8d">{"x":{"nodes":{"name":["model_batch","model_data","model_file_model","model_model","simulate_data","get_ranks"],"type":["stem","pattern","stem","pattern","function","function"],"description":[null,null,"model.stan","model.stan",null,null],"status":["uptodate","uptodate","uptodate","outdated","uptodate","outdated"],"seconds":[0.001,0.02,15.867,6.821,null,null],"bytes":[99,1959,2664966,6025,null,null],"branches":[null,5,null,5,null,null],"label":["model_batch","model_data","model_file_model\nmodel.stan","model_model\nmodel.stan","simulate_data","get_ranks"],"color":["#354823","#354823","#354823","#78B7C5","#354823","#78B7C5"],"id":["model_batch","model_data","model_file_model","model_model","simulate_data","get_ranks"],"level":[1,2,1,3,1,1],"shape":["dot","square","dot","square","triangle","triangle"]},"edges":{"from":["model_batch","simulate_data","get_ranks","model_data","model_file_model"],"to":["model_data","model_data","model_model","model_model","model_model"],"arrows":["to","to","to","to","to"]},"nodesToDataframe":true,"edgesToDataframe":true,"options":{"width":"100%","height":"100%","nodes":{"shape":"dot","physics":false},"manipulation":{"enabled":false},"edges":{"smooth":{"type":"cubicBezier","forceDirection":"horizontal"}},"physics":{"stabilization":false},"interaction":{"zoomSpeed":1},"layout":{"hierarchical":{"enabled":true,"direction":"LR"}}},"groups":null,"width":null,"height":null,"idselection":{"enabled":false,"style":"width: 150px; height: 26px","useLabels":true,"main":"Select by id"},"byselection":{"enabled":false,"style":"width: 150px; height: 26px","multiple":false,"hideColor":"rgba(200,200,200,0.5)","highlight":false},"main":{"text":"","style":"font-family:Georgia, Times New Roman, Times, serif;font-weight:bold;font-size:20px;text-align:center;"},"submain":null,"footer":null,"background":"rgba(0, 0, 0, 0)","highlight":{"enabled":true,"hoverNearest":false,"degree":{"from":1,"to":1},"algorithm":"hierarchical","hideColor":"rgba(200,200,200,0.5)","labelOnly":true},"collapse":{"enabled":true,"fit":false,"resetHighlight":true,"clusterOptions":null,"keepCoord":true,"labelSuffix":"(cluster)"},"legend":{"width":0.2,"useGroups":false,"position":"right","ncol":1,"stepX":100,"stepY":100,"zoom":true,"nodes":{"label":["Up to date","Outdated","Stem","Pattern","Function"],"color":["#354823","#78B7C5","#899DA4","#899DA4","#899DA4"],"shape":["dot","dot","dot","square","triangle"]},"nodesToDataframe":true},"tooltipStay":300,"tooltipStyle":"position: fixed;visibility:hidden;padding: 5px;white-space: nowrap;font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;-moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);"},"evals":[],"jsHooks":[]}</script><p>Let’s run the pipeline to compute a set of rank statistics for each simulated dataset.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_make.html" class="external-link">tar_make</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped target model_batch</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped target model_file_model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_b0b9380a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_ffcdb73c</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_b968a03a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_f8763cb2</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped branch model_data_0bfdabdc</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">✔</span><span style="color: #BB0000;"> skipped pattern model_data</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_5d061b58</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_5d061b58 [1.644 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_a9336683</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_a9336683 [1.334 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_bde6a6d6</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_bde6a6d6 [1.33 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_384f982f</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_384f982f [1.333 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> dispatched branch model_model_0d59666a</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed branch model_model_0d59666a [1.343 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #00BB00;">●</span><span style="color: #BB0000;"> completed pattern model_model</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span><span style="color: #0000BB;">▶</span><span style="color: #BB0000;"> ended pipeline [7.677 seconds]</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; Warning message:</span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; package ‘targets’ was built under R version 4.3.3 </span></span></span>
<span><span class="co"><span style="color: #BB0000;">#&gt; </span></span></span></code></pre></div>
<p>We have a data frame of rank statistics with one row per simulation rep and one column per model parameter.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/targets/reference/tar_load.html" class="external-link">tar_load</a></span><span class="op">(</span><span class="va">model_model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_model</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 7</span></span></span>
<span><span class="co">#&gt;    `beta[1]` `beta[2]` .rep     .dataset_id                .seed .file     .name</span></span>
<span><span class="co">#&gt;        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>      <span style="text-decoration: underline;">2</span>600       658 7c991244 model_data_b0b9380a_1 <span style="text-decoration: underline;">1</span>490<span style="text-decoration: underline;">816</span>252 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      <span style="text-decoration: underline;">2</span>616      <span style="text-decoration: underline;">2</span>049 e4141b79 model_data_b0b9380a_2 <span style="text-decoration: underline;">2</span>036<span style="text-decoration: underline;">930</span>449 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      <span style="text-decoration: underline;">3</span>098       298 b4f14839 model_data_ffcdb73c_1  483<span style="text-decoration: underline;">483</span>223 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      <span style="text-decoration: underline;">1</span>646      <span style="text-decoration: underline;">3</span>284 2c7051cc model_data_ffcdb73c_2  664<span style="text-decoration: underline;">499</span>179 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      <span style="text-decoration: underline;">1</span>122      <span style="text-decoration: underline;">3</span>083 4d2b0770 model_data_b968a03a_1 <span style="text-decoration: underline;">1</span>333<span style="text-decoration: underline;">721</span>666 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>       802      <span style="text-decoration: underline;">2</span>402 d3199d78 model_data_b968a03a_2  894<span style="text-decoration: underline;">289</span>376 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>      <span style="text-decoration: underline;">3</span>031       442 5768e060 model_data_f8763cb2_1   37<span style="text-decoration: underline;">052</span>332 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      <span style="text-decoration: underline;">2</span>831      <span style="text-decoration: underline;">3</span>572 5589c874 model_data_f8763cb2_2 <span style="text-decoration: underline;">1</span>333<span style="text-decoration: underline;">838</span>785 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>      <span style="text-decoration: underline;">3</span>647      <span style="text-decoration: underline;">3</span>022 a8ccdc62 model_data_0bfdabdc_1  573<span style="text-decoration: underline;">008</span>143 model.st… model</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>      <span style="text-decoration: underline;">3</span>543      <span style="text-decoration: underline;">1</span>781 f697a5d6 model_data_0bfdabdc_2 <span style="text-decoration: underline;">1</span>825<span style="text-decoration: underline;">978</span>703 model.st… model</span></span></code></pre></div>
<p>If the model is implemented correctly, then each the rank statistics each model parameter should be uniformly distributed. In practice, you may need thousands of simulation reps to make a judgment.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="va">model_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"beta"</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"parameter"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"ranks"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ranks</span><span class="op">)</span>, bins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-27-1.png" width="672"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-carpenter2017" class="csl-entry">
Carpenter, Bob. 2017. <span>“<span class="nocase">Bayesian Posteriors are Calibrated by Definition</span>.”</span> <a href="https://statmodeling.stat.columbia.edu/2017/04/12/bayesian-posteriors-calibrated/" class="external-link">https://statmodeling.stat.columbia.edu/2017/04/12/bayesian-posteriors-calibrated/</a>.
</div>
<div id="ref-cook2006" class="csl-entry">
Cook, Samantha R., Andrew Gelman, and Donald B. Rubin. 2006. <span>“Validation of Software for Bayesian Models Using Posterior Quantiles.”</span> <em>Journal of Computational and Graphical Statistics</em> 15 (3): 675–92. <a href="http://www.jstor.org/stable/27594203" class="external-link">http://www.jstor.org/stable/27594203</a>.
</div>
<div id="ref-sbc" class="csl-entry">
Kim, Shinyoung, Hyunji Moon, Martin Modrák, and Teemu Säilynoja. 2022. <em>SBC: Simulation Based Calibration for Rstan/Cmdstanr Models</em>.
</div>
<div id="ref-talts2020" class="csl-entry">
Talts, Sean, Michael Betancourt, Daniel Simpson, Aki Vehtari, and Andrew Gelman. 2020. <span>“Validating Bayesian Inference Algorithms with Simulation-Based Calibration.”</span> <a href="https://arxiv.org/abs/1804.06788" class="external-link">https://arxiv.org/abs/1804.06788</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
